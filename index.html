<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Registro de Ocorrências + Checklist - Quintas do Lago</title>
  <link rel="manifest" href="manifest.json">
  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("service-worker.js").catch(()=>{});
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f5f6fa; color: #333; margin: 0; padding: 20px; }
    h1, h2 { color: #21a498; margin:0; }
    .card { background: #fff; border-radius: 10px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    input, select, textarea, button { width: 100%; margin: 8px 0; padding: 10px; border-radius: 6px; border: 1px solid #ccc; box-sizing:border-box; }
    button { background: #21a498; color: white; font-weight: bold; cursor: pointer; }
    button.small { width:auto; padding:6px 10px; font-weight:600; }
    button:hover { background: #0077cc; }
    #painel, #registro, #checklistPage, #masterChecklists { display: none; }
    img.logo { max-width:160px; border-radius:6px; }
    .admin { border: 2px solid #0077cc; padding: 10px; margin-top: 20px; }
    .topbar { display: flex; justify-content: space-between; align-items: center; gap:10px; margin-bottom:16px; }
    .topbar-left { display:flex; flex-direction: column; align-items:center; gap:12px; }
    nav.buttons { display:flex; justify-content: center; gap:8px; align-items:center; flex-wrap: wrap;  }
	button.small { min-width: 100px;        /* tamanho mínimo para consistência */}
    .filters { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
    .filters input, .filters select { flex: 1; min-width:120px; }
    .item-row { display:flex; gap:8px; align-items:center; margin-bottom:8px; }
    .item-row .label { flex:1; }
    .obs { width:100%; margin-top:6px; display:none; }
    .emoji-btn { font-size:18px; padding:6px 10px; border-radius:6px; border:1px solid #ccc; background:white; cursor:pointer; }
    .emoji-btn.selected { box-shadow:inset 0 -2px 0 rgba(0,0,0,0.1); background:#e9f7ef; }
    .section-title { margin-top:8px; margin-bottom:12px; font-weight:700; color:#003d66; }
    .flex-row { display:flex; gap:8px; align-items:center; }
    .center { text-align:center; }
    .muted { color:#666; font-size:0.9em; }
    pre { background:#fafafa; padding:8px; border-radius:6px; overflow:auto; }
	  /* === Ajuste visual das imagens das ocorrências === */
.card img {
  max-width: 100%;
  height: auto;
  display: block;
  margin-top: 10px;
  border-radius: 8px;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
}

/* limita o tamanho visual */
#listaOcorrencias img {
  max-width: 300px;
  max-height: 200px;
  object-fit: cover;
  cursor: pointer;
  transition: transform 0.2s ease;
}

#listaOcorrencias img:hover {
  transform: scale(1.05);
}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="topbar-left center">
      <img class="logo" src="https://reombcvqyieerjomosbn.supabase.co/storage/v1/object/public/Assets/logo.png" alt="Logo">
      <h1>Registro de Ocorrências</h1>
    

    <nav class="buttons">
      <button id="btnMenuReg" class="small" style="display:none;">Registro</button>
      <button id="btnMenuPainel" class="small" style="display:none;">Ocorrências</button>
      <button id="btnChecklistOpen" class="small" style="display:none;">Checklist</button>
      <button id="btnSair" class="small" style="display:none;">Sair</button>
    </nav>
  </div>
 </div>

  <!-- LOGIN -->
  <div id="login" class="card">
    <h2>Entrar</h2>
    <input type="text" id="loginUser" placeholder="Nome ou telefone" />
    <input type="password" id="loginPass" placeholder="Senha" />
    <button id="btnLogin">Entrar</button>
	<button id="btnCadastrar" class="small" style="background:#ffa500; margin-top:8px;">Cadastrar</button>
  </div>

  <!-- REGISTRO DE OCORRÊNCIAS -->
  <div id="registro" class="card">
    <h2>Registrar Ocorrência</h2>
    <select id="tipo">
      <option value="">Selecione o tipo</option>
      <option>Segurança</option>
      <option>Iluminação</option>
      <option>Limpeza</option>
      <option>Infraestrutura</option>
      <option>Outros</option>
    </select>
    <input type="date" id="data" />
    <input type="time" id="hora" />
    <input type="text" id="local" placeholder="Local" />
    <textarea id="observacao" placeholder="Observações"></textarea>
    <input type="file" id="imagem" accept="image/*" />
    <button id="btnSalvar">Registrar</button>
  </div>

  <!-- PAINEL OCORRÊNCIAS -->
  <div id="painel" class="card">
    <h2>Ocorrências Registradas</h2>
    <div class="filters">
      <select id="filtroStatus">
        <option value="todas">Todas</option>
        <option value="pendente">Pendentes</option>
        <option value="concluída">Concluídas</option>
      </select>
      <input type="text" id="filtroLocal" placeholder="Filtrar por local (opcional)">
      <button id="btnRefresh" class="small">Atualizar</button>
    </div>

    <div id="listaOcorrencias"></div>

    <div id="adminPanel" class="admin" style="display:none;">
      <h3>Painel do Master</h3>
      <div class="filters">
        <input type="date" id="dataInicio" />
        <input type="date" id="dataFim" />
      </div>
      <button id="btnPDF">Gerar Relatório PDF</button>
    </div>
  </div>

  <!-- CHECKLIST PAGE -->
  <div id="checklistPage" class="card">
    <h2>Checklist de Espaços</h2>

    <div class="section-title">Escolha o espaço</div>
    <select id="selectEspaco">
      <option value="">-- selecione --</option>
      <option>Deck Gourmet</option>
      <option>Salão de Festas</option>
      <option>Salão de Jogos</option>
      <option>Churrasqueira 1</option>
      <option>Churrasqueira 2</option>
    </select>

    <div id="itensArea" style="display:none; margin-top:12px;">
      <div class="section-title">Itens do checklist</div>

      <div id="itemsList"></div>

      <div style="margin-top:12px;">
        <input type="text" id="novoItemNome" placeholder="Adicionar item (ex: Garfo e faca)" />
        <button id="btnAddItem" class="small">Adicionar Item</button>
      </div>

      <div style="margin-top:12px;">
        <textarea id="observacaoGeral" placeholder="Observação geral (opcional)"></textarea>
      </div>

      <div style="display:flex; gap:8px; margin-top:10px;">
        <button id="btnSalvarChecklist">Salvar Checklist</button>
        <button id="btnCancelarChecklist" class="small">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- MASTER: CHECKLISTS RECEBIDOS -->
  <div id="masterChecklists" class="card" style="display:none;">
    <h2>Checklists Recebidos</h2>

    <div class="filters">
      <select id="filtroEspacoMaster">
        <option value="todas">Todos os espaços</option>
        <option>Deck Gourmet</option>
        <option>Salão de Festas</option>
        <option>Salão de Jogos</option>
        <option>Churrasqueira 1</option>
        <option>Churrasqueira 2</option>
      </select>
      <input type="date" id="filtroDataInicioMaster" />
      <input type="date" id="filtroDataFimMaster" />
      <button id="btnRefreshMaster" class="small">Filtrar</button>
    </div>

    <div id="listaChecklistsMaster"></div>
  </div>

<script>
  // === Supabase setup (usando suas credenciais fornecidas) ===
  const SUPABASE_URL = "https://uudiqxghmognvkqfmknu.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV1ZGlxeGdobW9nbnZrcWZta251Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAyMDQ2MjMsImV4cCI6MjA3NTc4MDYyM30.oGj4_C_GUvdK5WEdIl3dWCZzwAUkCf3FTOvEPn0ERBY";
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  // state
  let currentUser = null;
  let isMaster = false;
  let ocorrenciasCache = [];
  let checklistItems = []; // [{id, name, ok:null/true/false, obs:''}]
  let checklistsCache = [];

  // ---------- NAV / UI helpers ----------
  const show = (id) => {
    ['login','registro','painel','checklistPage','masterChecklists'].forEach(i=>{
      document.getElementById(i).style.display = (i===id) ? 'block' : 'none';
    });
  };
  const showMenuButtons = () => {
    document.getElementById('btnMenuReg').style.display = 'inline-block';
    document.getElementById('btnMenuPainel').style.display = 'inline-block';
    document.getElementById('btnChecklistOpen').style.display = 'inline-block';
    document.getElementById('btnSair').style.display = 'inline-block';
    if (isMaster) {
      document.getElementById('adminPanel').style.display = 'block';
      document.getElementById('masterChecklists').style.display = 'block';
    } else {
      document.getElementById('adminPanel').style.display = 'none';
      document.getElementById('masterChecklists').style.display = 'none';
    }
  };

  // Buttons nav
  document.getElementById('btnMenuReg').onclick = ()=> { show('registro'); };
  document.getElementById('btnMenuPainel').onclick = ()=> { show('painel'); loadOcorrencias(); };
  // Botão "Checklist" com comportamento diferente para Master
document.getElementById('btnChecklistOpen').onclick = async () => {
  if (isMaster) {
    show('masterChecklists');
    await loadChecklistsMaster();
  } else {
    show('checklistPage');
  }
};

  document.getElementById('btnSair').onclick = () => {
    currentUser = null; isMaster = false;
    document.getElementById('btnMenuReg').style.display = 'none';
    document.getElementById('btnMenuPainel').style.display = 'none';
    document.getElementById('btnChecklistOpen').style.display = 'none';
    document.getElementById('btnSair').style.display = 'none';
    show('login');
  };


  // ---------- LOGIN ----------
  document.getElementById("btnLogin").onclick = async () => {
    const user = document.getElementById("loginUser").value.trim();
    const pass = document.getElementById("loginPass").value.trim();
    if (!user || !pass) return alert("Preencha os campos.");

    if (user === "Quintas do Lago" && pass === "12345678") {
      currentUser = "00000000-0000-0000-0000-000000000000";
      isMaster = true;
      showMenuButtons();
      show('painel');
      loadOcorrencias();
      loadChecklistsMaster(); // master view
      return;
    }

    const { data, error } = await supabase
      .from("usuarios")
      .select("*")
      .or(`nome.eq.${user},telefone.eq.${user}`)
      .eq("senha", pass)
      .single();

    if (error || !data) return alert("Usuário ou senha inválidos.");
    currentUser = data.id;
    isMaster = false;
    showMenuButtons();
    show('painel');
    loadOcorrencias();
  };

  // ---------- UPLOAD IMAGE ----------
  async function uploadImagem(file) {
    if (!file) return null;
    try {
      const nome = `${Date.now()}_${file.name}`;
      const { data, error } = await supabase.storage.from("ocorrencias").upload(nome, file);
      if (error) { console.error("Erro upload:", error); return null; }
      const { data: urlData } = supabase.storage.from("ocorrencias").getPublicUrl(nome);
      return urlData.publicUrl;
    } catch(e) {
      console.error(e);
      return null;
    }
  }

  // ---------- REGISTRAR OCORRÊNCIA (mantém seu fluxo) ----------
  document.getElementById("btnSalvar").onclick = async () => {
    const tipo = document.getElementById("tipo").value;
    const dataV = document.getElementById("data").value;
    const hora = document.getElementById("hora").value;
    const local = document.getElementById("local").value;
    const observacao = document.getElementById("observacao").value;
    const imagem = document.getElementById("imagem").files[0];

    if (!tipo || !dataV || !hora || !local || !observacao)
      return alert("Preencha todos os campos!");

    const imagem_url = await uploadImagem(imagem);

    const { error } = await supabase.from("ocorrencias").insert([{
      usuario_id: currentUser,
      tipo, data: dataV, hora, local, observacao, imagem_url,
      status: "pendente"
    }]);

    if (error) {
      console.error("Erro detalhado Supabase:", error);
      alert("Erro ao registrar ocorrência:\n" + JSON.stringify(error, null, 2));
      return;
    }

    alert("Ocorrência registrada!");
    loadOcorrencias();
    show('painel');
  };

  // ---------- LOAD OCORRÊNCIAS ----------
  async function loadOcorrencias() {
    let query = supabase.from("ocorrencias").select("*, usuarios (nome)").order("created_at", { ascending: false });
    const filtroLocal = document.getElementById('filtroLocal').value.trim();
    if (!isMaster) {
      query = query.eq("usuario_id", currentUser);
    }
    const { data, error } = await query;
    if (error) return console.error(error);
    ocorrenciasCache = data;
    renderOcorrencias();
  }

  document.getElementById('btnRefresh').onclick = loadOcorrencias;
  document.getElementById('filtroStatus').onchange = renderOcorrencias;

  function renderOcorrencias() {
    const lista = document.getElementById("listaOcorrencias");
    lista.innerHTML = "";
    const filtro = document.getElementById("filtroStatus").value;
    const filtroLocal = document.getElementById('filtroLocal').value.trim().toLowerCase();
    const ocorrenciasFiltradas = ocorrenciasCache.filter(o =>
      (filtro === "todas" ? true : o.status === filtro)
      && (!filtroLocal || (o.local || '').toLowerCase().includes(filtroLocal))
    );

    ocorrenciasFiltradas.forEach(o => {
      const div = document.createElement("div");
      div.classList.add("card");
      div.innerHTML = `
        <p><strong>Tipo:</strong> ${o.tipo}</p>
        <p><strong>Data:</strong> ${o.data} - ${o.hora}</p>
        <p><strong>Local:</strong> ${o.local}</p>
        <p><strong>Status:</strong> ${o.status}</p>
        <p><strong>Registrado por:</strong> ${o.usuarios?.nome || "Desconhecido"}</p>
        <p><strong>Obs:</strong> ${o.observacao}</p>
        ${o.imagem_url ? `<img src="${o.imagem_url}" />` : ""}
        ${
          isMaster && o.status === "pendente"
            ? `<div style="margin-top:8px;"><button onclick="finalizarOcorrencia('${o.id}')" class="small">Finalizar Ocorrência</button></div>`
            : o.status === "concluída"
              ? `<p><strong>Concluída em:</strong> ${o.data_conclusao || ""}</p>
                 ${o.imagem_conclusao_url ? `<img src="${o.imagem_conclusao_url}" />` : ""}`
              : ""
        }
      `;
      lista.appendChild(div);
    });
  }

  // ---------- FINALIZAR ----------
  async function finalizarOcorrencia(id) {
    const confirmar = confirm("Deseja realmente finalizar esta ocorrência?");
    if (!confirmar) return;

    const fileInput = document.createElement("input");
    fileInput.type = "file";
    fileInput.accept = "image/*";
    fileInput.click();

    fileInput.onchange = async () => {
      const file = fileInput.files[0];
      const imagem_conclusao_url = await uploadImagem(file);
     const hoje = new Date().toISOString().split("T")[0];



      const { error } = await supabase
        .from("ocorrencias")
        .update({ status: "concluída", data_conclusao: hoje, imagem_conclusao_url })
        .eq("id", id);

      if (error) {
        console.error(error);
        alert("Erro ao finalizar ocorrência.");
        return;
      }

      alert("Ocorrência finalizada!");
      loadOcorrencias();
    };
  }

  // ---------- CHECKLIST: UI helpers ----------
  const espacosDisponiveis = ["Deck Gourmet","Salão de Festas","Salão de Jogos","Churrasqueira 1","Churrasqueira 2"];

const itensFixosPorEspaco = {
  "SALÃO DE JOGOS": [
    "06 POLTRONAS",
    "01 MESA DE CENTRO COM CORDÃO ARTESANAL",
    "03 MESAS DE CANTOS",
    "2 LUMINÁRIAS",
    "01 MESA DE POKER + 06 CADEIRAS",
    "01 MESA DE SINUCA",
    "16 BOLAS DE SINUCA + 04 TACOS",
    "01 TV + VIDEO GAME + 02 CONTROLES",
    "01 SAPATO",
    "03 VASOS DE CERA",
    "02 ESCULTURAS ARTESANAIS",
    "01 FRIGOBAR",
    "01 LIXEIRA INOX"
  ],
  "SALÃO DE FESTAS": [
    "06 MESAS COM 4 CADEIRAS",
    "02 MESAS COM 5 CADEIRAS",
    "02 MESAS COM 3 CADEIRAS",
    "02 SOFÁS DE 4 LUGARES COM 4 ALMOFADAS",
    "02 MESAS DE CANTO",
    "06 CADEIRAS DE BANCADA",
    "02 MESAS APARADOR",
    "01 LIVRO ARTESANAL",
    "01 ESCULTURAS BARRO",
    "01 CESTO DE PALHA",
    "01 PEÇA DECORATIVA ARTESANAL",
    "02 VASOS DE CERA BEGE",
    "02 VASOS PORCELANAS",
    "01 KIT ARTESANAL VASO MAIS PEÇA DECORATIVA",
    "04 VASOS DECORATIVO BARRO",
    "01 PEÇA DECORATIVA MADEIRA",
    "01 CHOPEIRA",
    "01 ADEGA",
    "01 FRIGOBAR",
    "01 FOGÃO POR INDUÇÃO",
    "01 JOGO DE PANELAS 5 UNIDADES (INDUÇÃO)",
    "02 LIXEIRA INOX",
    "01 FOGÃO A GÁS"
  ],
  "DECK GOURMET": [
    "04 MESAS COM 5 CADEIRAS",
    "01 BANCADA COM 8 CADEIRAS",
    "01 FOGÃO POR INDUÇÃO",
    "01 KIT CHURRASCO COM 2 ESPETOS E 2 GARFOS",
    "02 FREEZER VERTICAL",
    "02 PEÇAS DECORATIVAS DE MADEIRA",
    "01 ESCULTURA POLIRESINA PEIXE",
    "01 CESTO CAPIM DOURADO COM 9 ESCULTURAS DE COCO",
    "01 JOGO DE PANELA 5 UNIDADES (INDUÇÃO)",
    "01 TABUA PARA CHURRASCO",
    "01 LIXEIRA INOX",
    "01 SUPERZON"
  ],
  "CHURRASQUEIRA 1": [
    "03 MESAS COM 5 CADEIRAS",
    "01 GRELHA + 05 ESPETOS",
    "01 TÁBUA CHURRASCO",
    "06 JARROS",
    "03 QUADROS",
    "01 FREEZER VERTICAL",
    "01 SUPERZON"
  ],
  "CHURRASQUEIRA 2": [
    "05 MESAS COM 4 CADEIRAS",
    "01 GRELHA + 05 ESPETOS",
    "01 TÁBUA CHURRASCO",
    "06 JARROS",
    "03 QUADROS",
    "01 FREEZER VERTICAL",
    "01 SUPERZON"
  ]
};

document.getElementById('selectEspaco').onchange = () => {
  const esp = document.getElementById('selectEspaco').value;
  checklistItems = [];
  document.getElementById('itemsList').innerHTML = '';
  document.getElementById('observacaoGeral').value = '';

  if (esp) {
    document.getElementById('itensArea').style.display = 'block';
    
    // Adicionar itens fixos automaticamente
    const itensFixos = itensFixosPorEspaco[esp.toUpperCase()] || [];
    itensFixos.forEach(itemNome => addItemToList(itemNome));
    
  } else {
    document.getElementById('itensArea').style.display = 'none';
  }
};


  // Add item to checklistItems and render
  function addItemToList(name) {
    const id = Date.now().toString(36) + Math.random().toString(36).slice(2,6);
    const item = { id, name, ok: null, obs: '' };
    checklistItems.push(item);
    renderChecklistItems();
  }

  document.getElementById('btnAddItem').onclick = () => {
    const v = document.getElementById('novoItemNome').value.trim();
    if (!v) return alert("Informe o nome do item.");
    addItemToList(v);
    document.getElementById('novoItemNome').value = '';
  };

  function renderChecklistItems() {
    const list = document.getElementById('itemsList');
    list.innerHTML = '';
    checklistItems.forEach(it => {
      const row = document.createElement('div');
      row.className = 'card';
      row.style.marginBottom = '8px';
      row.innerHTML = `
        <div class="item-row">
          <div class="label">${it.name}</div>
          <div style="display:flex; gap:6px; align-items:center;">
            <button class="emoji-btn" data-id="${it.id}" data-val="true">✅</button>
            <button class="emoji-btn" data-id="${it.id}" data-val="false">❌</button>
          </div>
        </div>
        <textarea class="obs" id="obs-${it.id}" placeholder="Observação (aparecerá se marcado ❌)">${it.obs || ''}</textarea>
      `;
      list.appendChild(row);

      // attach events
      const yesBtn = row.querySelector(`button[data-val="true"]`);
      const noBtn = row.querySelector(`button[data-val="false"]`);
      const obsEl = row.querySelector(`#obs-${it.id}`);

      // set current selection visual
      if (it.ok === true) {
        yesBtn.classList.add('selected');
        noBtn.classList.remove('selected');
        obsEl.style.display = 'none';
      } else if (it.ok === false) {
        noBtn.classList.add('selected');
        yesBtn.classList.remove('selected');
        obsEl.style.display = 'block';
      } else {
        yesBtn.classList.remove('selected');
        noBtn.classList.remove('selected');
        obsEl.style.display = 'none';
      }

      yesBtn.onclick = () => {
        it.ok = true;
        it.obs = '';
        renderChecklistItems();
      };
      noBtn.onclick = () => {
        it.ok = false;
        renderChecklistItems();
        // show obs field for this item so user can type
        setTimeout(()=> {
          const field = document.getElementById(`obs-${it.id}`);
          if (field) {
            field.style.display = 'block';
            field.focus();
            field.oninput = (e)=> it.obs = e.target.value;
          }
        },50);
      };

      // bind oninput
      obsEl.oninput = (e) => {
        it.obs = e.target.value;
      };
    });
  }

  document.getElementById('btnCancelarChecklist').onclick = () => {
    // clear and go back to painel
    checklistItems = [];
    document.getElementById('selectEspaco').value = '';
    document.getElementById('itensArea').style.display = 'none';
    show('painel');
  };

  // ---------- SAVE CHECKLIST to Supabase ----------
  document.getElementById('btnSalvarChecklist').onclick = async () => {
    const esp = document.getElementById('selectEspaco').value;
    if (!esp) return alert("Selecione o espaço.");

    if (checklistItems.length === 0) {
      if (!confirm("Nenhum item adicionado. Deseja salvar um checklist vazio?")) return;
    }

    // transform items to object: { "item name": { ok: true/false/null, obs: "..." }, ... }
    const itensObj = {};
    checklistItems.forEach(it => {
      itensObj[it.name] = { ok: it.ok === true, problem: it.ok === false, obs: it.obs || '' };
    });

    const payload = {
      usuario_id: currentUser,
      espaco: esp,
      itens: itensObj,
      data: const agora = new Date();
const dataISOlocal = new Date(agora.getTime() - agora.getTimezoneOffset() * 60000).toISOString();
,
      status: "finalizado",
      observacao_geral: document.getElementById('observacaoGeral').value || null
    };

    const { error } = await supabase.from('checklists').insert([payload]);
    if (error) {
      console.error("Erro ao salvar checklist:", error);
      alert("Erro ao salvar checklist: " + (error.message || JSON.stringify(error)));
      return;
    }

    alert("Checklist salvo com sucesso!");
    // clear form
    checklistItems = [];
    document.getElementById('selectEspaco').value = '';
    document.getElementById('itensArea').style.display = 'none';
    document.getElementById('observacaoGeral').value = '';
    // if master view visible, refresh master list
    if (isMaster) loadChecklistsMaster();
    show('painel');
  };

  // ---------- MASTER: load checklists ----------
  async function loadChecklistsMaster() {
    // only for master
    if (!isMaster) return;
    // basic load
    const { data, error } = await supabase.from('checklists').select('*, usuarios (nome)').order('created_at', { ascending: false });
    if (error) return console.error("Erro ao carregar checklists:", error);
    checklistsCache = data;
    renderMasterChecklists();
  }

async function showMasterChecklistPanel() {
  const checklistArea = document.getElementById('checklistArea');
  checklistArea.innerHTML = `
    <h2>Supervisão de Checklists</h2>

    <div class="filtrosMaster">
      <label>Espaço:</label>
      <select id="filtroEspaco">
        <option value="">Todos</option>
        <option>SALÃO DE JOGOS</option>
        <option>SALÃO DE FESTAS</option>
        <option>DECK GOURMET</option>
        <option>CHURRASQUEIRA 1</option>
        <option>CHURRASQUEIRA 2</option>
      </select>

      <label>Usuário:</label>
      <input type="text" id="filtroUsuario" placeholder="Nome do usuário...">

      <label>Data:</label>
      <input type="date" id="filtroData">

      <button id="btnFiltrarChecklists">Filtrar</button>
    </div>

    <div id="listaChecklistsMaster" class="lista-checklists"></div>
  `;

  // Carrega checklists na primeira exibição
  await loadChecklistsMaster();

  // Evento de filtro
  document.getElementById('btnFiltrarChecklists').onclick = async () => {
    const espaco = document.getElementById('filtroEspaco').value;
    const usuario = document.getElementById('filtroUsuario').value.trim();
    const data = document.getElementById('filtroData').value;

    let query = supabase
      .from('checklists')
      .select('*, usuarios (nome)')
      .order('created_at', { ascending: false });

    if (espaco) query = query.eq('espaco', espaco);
    if (usuario) query = query.ilike('usuarios.nome', `%${usuario}%`);
    if (data) query = query.eq('data', data);

    const { data: results, error } = await query;
    if (error) {
      console.error(error);
      return alert("Erro ao filtrar checklists");
    }

    renderMasterChecklists(results);
  };
}


  document.getElementById('btnRefreshMaster').onclick = loadChecklistsMaster;

function renderMasterChecklists(data = checklistsCache) {
  const container = document.getElementById('listaChecklistsMaster');
  if (!container) return;
  container.innerHTML = '';

  if (!data || data.length === 0) {
    container.innerHTML = '<p>Nenhum checklist encontrado.</p>';
    return;
  }

  data.forEach((item, index) => {
    // Corrige o horário para o fuso de Brasília
    const dataLocal = new Date(item.data);
    const dataFormatada = dataLocal.toLocaleString('pt-BR', {
      timeZone: 'America/Sao_Paulo',
      day: '2-digit',
      month: '2-digit',
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });

    const itensLista = Object.entries(item.itens || {})
      .map(([nome, v]) => `${v.ok ? '✅' : '❌'} ${nome}${v.obs ? ' - ' + v.obs : ''}`)
      .join('<br>');

    // Cria o card do checklist
    const div = document.createElement('div');
    div.className = 'card';
    div.style.cursor = 'pointer';
    div.style.marginBottom = '10px';
    div.style.border = '1px solid #ddd';
    div.style.borderRadius = '10px';
    div.style.padding = '10px';
    div.style.backgroundColor = '#fafafa';
    div.style.transition = 'background-color 0.2s ease';

    // Cabeçalho do card com seta
    div.innerHTML = `
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div>
          <h3 style="margin:0;">${item.espaco}</h3>
          <p style="margin:2px 0;"><strong>Data:</strong> ${dataFormatada}</p>
          <p style="margin:2px 0;"><strong>Usuário:</strong> ${item.usuarios?.nome || '—'}</p>
        </div>
        <span id="seta-${index}" style="font-size:18px;">⯈</span>
      </div>
      <div id="detalhes-${index}" style="display:none; margin-top:8px; border-top:1px solid #eee; padding-top:6px;">
        <div><strong>Itens:</strong><br>${itensLista}</div>
        ${item.observacao_geral ? `<p><strong>Observação geral:</strong> ${item.observacao_geral}</p>` : ''}
      </div>
    `;

    // Efeito hover leve
    div.addEventListener('mouseenter', () => (div.style.backgroundColor = '#f0f0f0'));
    div.addEventListener('mouseleave', () => (div.style.backgroundColor = '#fafafa'));

    // Toggle (expandir/recolher + muda seta)
    div.addEventListener('click', () => {
      const detalhes = document.getElementById(`detalhes-${index}`);
      const seta = document.getElementById(`seta-${index}`);
      const aberto = detalhes.style.display === 'block';
      detalhes.style.display = aberto ? 'none' : 'block';
      seta.textContent = aberto ? '⯈' : '⯆';
    });

    container.appendChild(div);
  });
}


document.getElementById('btnCadastrar').onclick = async () => {
  const nome = prompt("Digite seu nome completo:");
  if (!nome) return alert("Nome obrigatório.");

  const telefone = prompt("Digite seu telefone:");
  if (!telefone) return alert("Telefone obrigatório.");

  const senha = prompt("Digite uma senha:");
  if (!senha) return alert("Senha obrigatória.");

  // verificar se já existe usuário com o mesmo nome ou telefone
  const { data: existing, error: checkError } = await supabase
    .from("usuarios")
    .select("*")
    .or(`nome.eq.${nome},telefone.eq.${telefone}`)
    .limit(1);

  if (checkError) return alert("Erro ao verificar usuário: " + checkError.message);
  if (existing.length > 0) return alert("Já existe um usuário com esse nome ou telefone.");

  // inserir no Supabase
  const { data, error } = await supabase
    .from("usuarios")
    .insert([{ nome, telefone, senha }]);

  if (error) return alert("Erro ao cadastrar: " + error.message);

  alert("Cadastro realizado com sucesso! Agora você pode fazer login.");
};


  // ---------- Init: show login ----------
  show('login');

  // Optional: expose some functions to window for debugging
  window.loadOcorrencias = loadOcorrencias;
  window.loadChecklistsMaster = loadChecklistsMaster;

  // If user is master and on load, show menu (handy for development)
  // showMenuButtons(); // will be toggled after login
</script>
</body>
</html>











